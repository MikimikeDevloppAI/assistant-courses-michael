<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí Assistant Courses Michael</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .workflow-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .step {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .step:hover {
            transform: translateY(-5px);
        }
        
        .step.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        
        .step.active .step-number {
            background: rgba(255,255,255,0.3);
        }
        
        .content-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .recette-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .recette-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .recette-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .recette-card .checkmark {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .recette-card.selected .checkmark {
            display: flex;
        }
        
        .recette-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .recette-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .recette-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .recette-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .tag {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .ia-score {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .button.secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .liste-courses {
            margin-top: 20px;
        }
        
        .rayon {
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }
        
        .rayon-titre {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .produit {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .produit:last-child {
            border-bottom: none;
        }
        
        .produit-info {
            flex-grow: 1;
        }
        
        .produit-nom {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .produit-details {
            font-size: 0.9rem;
            color: #666;
        }
        
        .produit-prix {
            font-weight: bold;
            color: #667eea;
        }
        
        .total-section {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }
        
        .stock-checker {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stock-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stock-item label {
            min-width: 120px;
            font-weight: 500;
        }
        
        .stock-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            .suggestions-grid { grid-template-columns: 1fr; }
            .workflow-steps { flex-direction: column; align-items: center; }
            .step { min-width: 200px; }
            .header h1 { font-size: 2rem; }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Assistant Courses Michael</h1>
            <p>IA personnalis√©e pour optimiser tes courses et repas</p>
        </div>
        
        <div class="workflow-steps">
            <div class="step active" id="step-1">
                <div class="step-number">1</div>
                <div>Suggestions IA</div>
            </div>
            <div class="step" id="step-2">
                <div class="step-number">2</div>
                <div>Choix Repas</div>
            </div>
            <div class="step" id="step-3">
                <div class="step-number">3</div>
                <div>V√©rif Stock</div>
            </div>
            <div class="step" id="step-4">
                <div class="step-number">4</div>
                <div>Liste Coop</div>
            </div>
        </div>
        
        <!-- √âtape 1: Suggestions -->
        <div class="content-panel" id="panel-suggestions">
            <h2>ü§ñ Suggestions Personnalis√©es</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Bas√©es sur tes habitudes, la p√©riode et tes pr√©f√©rences d'apprentissage IA
            </p>
            
            <div class="suggestions-grid" id="suggestions-container">
                <div class="loading">Chargement des suggestions personnalis√©es...</div>
            </div>
            
            <div style="text-align: center;">
                <button class="button" onclick="nouvelles_suggestions()">üîÑ Nouvelles Suggestions</button>
                <button class="button" onclick="valider_choix()" disabled id="btn-valider">
                    ‚úÖ Valider S√©lection (<span id="count-selection">0</span>)
                </button>
            </div>
        </div>
        
        <!-- √âtape 2: V√©rification stock (cach√©e initialement) -->
        <div class="content-panel hidden" id="panel-stock">
            <h2>üì¶ V√©rification de ton Stock</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Indique ce que tu as d√©j√† en stock pour optimiser la liste de courses
            </p>
            
            <div class="stock-checker" id="stock-container">
                <div class="loading">Analyse des ingr√©dients n√©cessaires...</div>
            </div>
            
            <div style="text-align: center;">
                <button class="button" onclick="generer_liste()">üõí G√©n√©rer Liste Courses Coop</button>
            </div>
        </div>
        
        <!-- √âtape 3: Liste de courses (cach√©e initialement) -->
        <div class="content-panel hidden" id="panel-liste">
            <h2>üõí Ta Liste de Courses Coop</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Organis√©e par rayons pour optimiser ton parcours en magasin
            </p>
            
            <div class="liste-courses" id="liste-container">
                <div class="loading">G√©n√©ration de ta liste personnalis√©e...</div>
            </div>
        </div>
    </div>
    
    <script>
        let recettes_choisies = [];
        let stock_ingredients = {};
        
        // Charger les suggestions au d√©marrage
        document.addEventListener('DOMContentLoaded', function() {
            charger_suggestions();
        });
        
        async function charger_suggestions() {
            try {
                const response = await fetch('/api/suggestions?nombre=6');
                const suggestions = await response.json();
                afficher_suggestions(suggestions);
            } catch (error) {
                console.error('Erreur chargement suggestions:', error);
                document.getElementById('suggestions-container').innerHTML = 
                    '<div style="color: red;">Erreur de chargement. Rafra√Æchis la page.</div>';
            }
        }
        
        function afficher_suggestions(suggestions) {
            const container = document.getElementById('suggestions-container');
            container.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const card = document.createElement('div');
                card.className = 'recette-card';
                card.onclick = () => toggle_recette(suggestion.id, card);
                
                const difficulteIcon = {
                    'facile': 'üòä',
                    'moyen': 'ü§î', 
                    'difficile': 'üò∞'
                };
                
                card.innerHTML = `
                    <div class="ia-score">IA: ${suggestion.score_ia}</div>
                    <div class="checkmark">‚úì</div>
                    <div class="recette-title">${suggestion.nom}</div>
                    <div class="recette-meta">
                        <span>‚è±Ô∏è ${suggestion.temps_prep} min</span>
                        <span>${difficulteIcon[suggestion.difficulte]} ${suggestion.difficulte}</span>
                        <span>üë• ${suggestion.portions} portions</span>
                    </div>
                    <div class="recette-tags">
                        ${suggestion.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function toggle_recette(recette_id, card) {
            if (recettes_choisies.includes(recette_id)) {
                recettes_choisies = recettes_choisies.filter(id => id !== recette_id);
                card.classList.remove('selected');
            } else {
                recettes_choisies.push(recette_id);
                card.classList.add('selected');
            }
            
            // Mettre √† jour le compteur
            const count = document.getElementById('count-selection');
            const btn = document.getElementById('btn-valider');
            count.textContent = recettes_choisies.length;
            btn.disabled = recettes_choisies.length === 0;
        }
        
        async function nouvelles_suggestions() {
            document.getElementById('suggestions-container').innerHTML = 
                '<div class="loading">Nouvelles suggestions personnalis√©es...</div>';
            recettes_choisies = [];
            document.getElementById('count-selection').textContent = '0';
            document.getElementById('btn-valider').disabled = true;
            
            // Attendre un peu pour l'effet
            setTimeout(charger_suggestions, 500);
        }
        
        async function valider_choix() {
            // Enregistrer les choix pour l'apprentissage
            for (const recette_id of recettes_choisies) {
                await fetch('/api/choix', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({recette_id, choix: 'choisi'})
                });
            }
            
            // Passer √† l'√©tape stock
            document.getElementById('step-1').classList.remove('active');
            document.getElementById('step-2').classList.add('active');
            document.getElementById('panel-suggestions').classList.add('hidden');
            document.getElementById('panel-stock').classList.remove('hidden');
            
            // Charger la v√©rification du stock
            await charger_verification_stock();
        }
        
        async function charger_verification_stock() {
            try {
                const response = await fetch('/api/liste-courses', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({recettes: recettes_choisies})
                });
                
                const data = await response.json();
                afficher_verification_stock(data);
            } catch (error) {
                console.error('Erreur v√©rification stock:', error);
            }
        }
        
        function afficher_verification_stock(data) {
            const container = document.getElementById('stock-container');
            container.innerHTML = '<h3>ü§î Qu\\'as-tu d√©j√† en stock ?</h3>';
            
            // Cr√©er les contr√¥les pour chaque ingr√©dient
            const ingredients_uniques = new Set();
            Object.values(data.liste_par_rayon).flat().forEach(item => {
                ingredients_uniques.add(item.nom);
            });
            
            ingredients_uniques.forEach(ingredient => {
                const div = document.createElement('div');
                div.className = 'stock-item';
                div.innerHTML = `
                    <label>${ingredient}:</label>
                    <select class="stock-select" onchange="update_stock('${ingredient}', this.value)">
                        <option value="pas_en_stock">‚ùå Pas en stock</option>
                        <option value="stock_bas">‚ö†Ô∏è Stock bas</option>
                        <option value="stock_ok">‚úÖ J'en ai assez</option>
                    </select>
                `;
                container.appendChild(div);
            });
            
            // Stocker les donn√©es pour la g√©n√©ration finale
            window.liste_complete = data;
        }
        
        function update_stock(ingredient, niveau) {
            stock_ingredients[ingredient] = niveau;
        }
        
        async function generer_liste() {
            // Filtrer selon le stock d√©clar√©
            const liste_finale = {...window.liste_complete};
            
            // Supprimer les articles en stock suffisant
            Object.keys(liste_finale.liste_par_rayon).forEach(rayon => {
                liste_finale.liste_par_rayon[rayon] = liste_finale.liste_par_rayon[rayon].filter(
                    item => stock_ingredients[item.nom] !== 'stock_ok'
                );
                // Supprimer les rayons vides
                if (liste_finale.liste_par_rayon[rayon].length === 0) {
                    delete liste_finale.liste_par_rayon[rayon];
                }
            });
            
            // Recalculer le total
            let nouveau_total = 0;
            Object.values(liste_finale.liste_par_rayon).flat().forEach(item => {
                nouveau_total += item.prix_estime;
            });
            liste_finale.total_estime = Math.round(nouveau_total * 100) / 100;
            
            // Passer √† l'√©tape liste
            document.getElementById('step-2').classList.remove('active');
            document.getElementById('step-3').classList.add('active');
            document.getElementById('panel-stock').classList.add('hidden');
            document.getElementById('panel-liste').classList.remove('hidden');
            
            afficher_liste_courses(liste_finale);
        }
        
        function afficher_liste_courses(data) {
            const container = document.getElementById('liste-container');
            container.innerHTML = '';
            
            // Afficher chaque rayon
            Object.entries(data.liste_par_rayon).forEach(([rayon_nom, articles]) => {
                const rayon_div = document.createElement('div');
                rayon_div.className = 'rayon';
                rayon_div.innerHTML = `<div class="rayon-titre">${rayon_nom}</div>`;
                
                articles.forEach(article => {
                    const produit_div = document.createElement('div');
                    produit_div.className = 'produit';
                    
                    const status_icon = article.status === 'stock_bas' ? '‚ö†Ô∏è' : 'üõí';
                    
                    produit_div.innerHTML = `
                        <div class="produit-info">
                            <div class="produit-nom">${status_icon} ${article.nom}</div>
                            <div class="produit-details">${article.quantite} - ${article.unite}</div>
                        </div>
                        <div class="produit-prix">CHF ${article.prix_estime.toFixed(2)}</div>
                    `;
                    
                    rayon_div.appendChild(produit_div);
                });
                
                container.appendChild(rayon_div);
            });
            
            // Section total
            const articles_count = Object.values(data.liste_par_rayon).flat().length;
            const total_div = document.createElement('div');
            total_div.className = 'total-section';
            total_div.innerHTML = `
                <h3>üí∞ Total Estim√©: CHF ${data.total_estime}</h3>
                <p>${articles_count} articles √† acheter chez Coop</p>
                <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                    üì± Conseil: Screenshot cette liste pour tes courses !
                </p>
            `;
            container.appendChild(total_div);
        }
    </script>
</body>
</html>